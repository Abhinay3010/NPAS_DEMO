name: Phase 1 - Bootstrap

on:
  workflow_dispatch:

jobs:
  bootstrap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up tools
        run: |
          sudo apt-get update
          sudo apt-get install -y curl unzip
          curl -sSL https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o yq
          chmod +x yq
          sudo mv yq /usr/local/bin/yq

      # ---------- SONAR (NON BLOCKING) ----------
      - name: Sonar Scan (non-blocking)
        continue-on-error: true
        uses: sonarsource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=NPAS_DEMO
            -Dsonar.organization=npas-demo
            -Dsonar.sources=.

      # ---------- SYFT (SBOM) ----------
      - name: Generate SBOM (Syft)
        continue-on-error: true
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh
          ./bin/syft dir:. -o json > sbom.json

      # ---------- TRIVY ----------
      - name: Trivy filesystem scan
        continue-on-error: true
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          scan-ref: .
          format: table

      # ---------- BOOTSTRAP ACTION ----------
      - name: Add NGINX Certificate (manual equivalent)
        run: |
          chmod +x shell/nginxconf.sh
          source shell/nginxconf.sh
